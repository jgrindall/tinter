<!doctype html>
<html lang="en">
	
	<head>

		<meta charset="utf-8">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="viewport" content = "width = device-width, initial-scale = 1.0, user-scalable = no, minimum-scale = 1, maximum-scale = 1" />
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
		
		<style>
			*{
				font-family:Helvetica, Verdana,Arial,sans-serif;
				font-size:17px;
				color:#222;
			}
			label, input, button, p, span, img, textarea{
				margin:20px;
			}
			label{
				font-weight:bold;
			}
			ul img{
				width:500px;
				display:block;
			}
			textarea{
				font-family:monospace;
			}
		</style>
		
	</head>
	
	<body>
	
		<img style='margin:0 !important;' src="logo.png" height="80"/>

		<form id="form">
			<label>1. Upload your image.</label>
			<br/>
			<input type="file" name="uploads[]" multiple="multiple"></input>
			<br/>
			<br/>
			<label>2. Enter your hex colors to tint with (one on each line, with #)</label>
			<br/>
			<textarea id="hex" rows="10" cols="20" wrap="soft"></textarea>
			<br/>
			<br/>
			<button id="submit">Submit</button>
			<button id="clear" >Clear</button>
		</form>
		
		<br/>
		<hr/>
		<br/>
		<label>3. Check and <a id='download' style='color:blue;' href='/download'>download</a> your images.</label>
		<br/>
		<br/>
		
		<ul id="images"></ul>
		
		<script>
			
			var getFormData = function(){
				var formData, hex, files;
				formData = new FormData();
				hex = $("#hex").val().toLowerCase().replace(/[^01234567889abcdef#\n]/gi, '').split("\n");
				hex = _.compact(hex);
				files = $("#form input[type=file]").get(0).files;
				if (files.length > 0){
					formData = new FormData();
					formData.append('uploads[]', files[0], files[0].name);
					formData.append("colors", hex.join(","));
				}
				//TODO - verify
				return formData;
			};
			
			$(document).ready(function(){
				var input = $("input[type=file]");
				$("button#clear").on("click", function(e){
					e.stopPropagation();
					e.preventDefault();
					$("ul#images").empty();
					return false;
				});
				$("button#submit").on("click", function(e){
					var hex, formData, files;
					e.stopPropagation();
					e.preventDefault();
					hex = $("#hex").val().toLowerCase().replace(/[^01234567889abcdef#\n]/gi, '').split("\n");
					hex = _.compact(hex);
					files = $("#form input[type=file]").get(0).files;
					if (files.length > 0){
						formData = new FormData();
						formData.append('uploads[]', files[0], files[0].name);
						formData.append("colors", hex.join(","));
						$.ajax({
							url: "/upload",
							type: 'post',
							data: formData,
							processData: false,
							contentType: false,
							success: function (response) {
								setTimeout(function(){
									$("#download").attr("href", "/download?token=" + response.token);
									for(var i = 0; i < response.num; i++){
										var img = $("<img/>");
										$("#images").append(img);
										img.attr("src", "/uploads/upload_" + response.token + "/new_" + i + ".png");
									}
								}, 1000);
							}
						});
					}
					return false;
				});
			});
		
		</script>
		
	</body>
	
</html>
